# ***\*系统安全配置与策略管理数据库设计说明书\****

***\*1. 设计概述\****

本设计旨在构建一套灵活的防火墙策略管理系统。通过将“安全配置（任务维度）”与“防护规则（策略维度）”解耦，并引入“关联编排表”，实现对 iptables 规则的原子化复用与自定义顺序执行。

***\*2. 实体关系图(ER)逻辑\****

系统由三个核心实体组成：

1. 配置模式(Modes)：对应众测任务或业务场景（1端）。
2. 防护规则(Rules)：对应具体的网络五元组规则池（1端）。
3. 策略编排(Relations)：对应具体的规则执行顺序与关联关系（N端，关联中心）。

***\*3. 详细表结构设计\****

***\*表1：安全配置模式表 (sec_config_modes)\****

用途：定义众测任务维度的安全配置集合（即“策略组”）。

| **字段名**  | **类型**     | **必填** | **默认值** | **备注说明**                   |
| ----------- | ------------ | -------- | ---------- | ------------------------------ |
| id          | BIGINT       | YES      | Auto Inc   | 主键 ID                        |
| mode_name   | VARCHAR(100) | YES      | -          | 配置名称 (如: Web业务专用防护) |
| description | VARCHAR(255) | NO       | NULL       | 业务描述                       |
| created_at  | DATETIME     | YES      | Now()      | 创建时间                       |

***\*表2：安全防护规则池表 (sec_firewall_rules)\****

用途：存储原子化的安全策略。此表不包含优先级，仅作为可选的规则库（Menu）。

| **字段名** | **类型**     | **必填** | **默认值**  | **备注说明**                         |
| ---------- | ------------ | -------- | ----------- | ------------------------------------ |
| id         | BIGINT       | YES      | Auto Inc    | 主键 ID                              |
| rule_name  | VARCHAR(100) | YES      | -           | 规则标识名 (如: 封禁恶意IP段)        |
| direction  | ENUM         | YES      | 'INPUT'     | 方向: 'INPUT'(入站), 'OUTPUT'(出站)  |
| protocol   | VARCHAR(10)  | YES      | 'tcp'       | 协议类型: tcp, udp, icmp, all        |
| src_ip     | VARCHAR(50)  | NO       | '0.0.0.0/0' | 源 IP/CIDR                           |
| dst_port   | VARCHAR(50)  | NO       | NULL        | 目标端口 (NULL代表所有)              |
| action     | ENUM         | YES      | 'ACCEPT'    | 策略动作: 'ACCEPT', 'DROP', 'REJECT' |
| is_active  | TINYINT      | YES      | 1           | 规则状态: 1-启用, 0-停用             |

***\*表3：策略编排关联表 (sec_mode_rule_relations)\****

用途：核心逻辑表。将规则绑定到配置模式，并由用户定义执行顺序。

| **字段名** | **类型** | **必填** | **默认值** | **备注说明**                       |
| ---------- | -------- | -------- | ---------- | ---------------------------------- |
| id         | BIGINT   | YES      | Auto Inc   | 主键 ID                            |
| mode_id    | BIGINT   | YES      | -          | 关联表1 ID (外键)                  |
| rule_id    | BIGINT   | YES      | -          | 关联表2 ID (外键)                  |
| sort_order | INT      | YES      | 1          | 执行序号: 数值越小，在脚本中越靠前 |

 

***\*4. SQL 脚本 (DDL)\****

-- 1. 安全配置模式表

CREATE TABLE sec_config_modes (

  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '主键',

  mode_name VARCHAR(100) NOT NULL COMMENT '配置模式名称',

  description VARCHAR(255) COMMENT '描述',

  created_at DATETIME DEFAULT CURRENT_TIMESTAMP

) COMMENT='众测任务安全配置模式表';

 

-- 2. 安全防护规则池表

CREATE TABLE sec_firewall_rules (

  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '主键',

  rule_name VARCHAR(100) NOT NULL COMMENT '规则名称',

  direction ENUM('INPUT', 'OUTPUT') DEFAULT 'INPUT' COMMENT '流量方向',

  protocol VARCHAR(10) DEFAULT 'tcp' COMMENT '协议',

  src_ip VARCHAR(50) DEFAULT '0.0.0.0/0' COMMENT '源IP地址',

  dst_port VARCHAR(50) DEFAULT NULL COMMENT '目标端口',

  action ENUM('ACCEPT', 'DROP', 'REJECT') DEFAULT 'ACCEPT' COMMENT '动作',

  is_active TINYINT DEFAULT 1 COMMENT '是否启用: 1是0否'

) COMMENT='安全防护规则原子池';

 

-- 3. 策略编排关联表

CREATE TABLE sec_mode_rule_relations (

  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '主键',

  mode_id BIGINT UNSIGNED NOT NULL COMMENT '配置模式ID',

  rule_id BIGINT UNSIGNED NOT NULL COMMENT '规则ID',

  sort_order INT NOT NULL DEFAULT 1 COMMENT '执行顺序(用户自定义)',

  

  -- 建立外键约束与索引

  CONSTRAINT fk_mode FOREIGN KEY (mode_id) REFERENCES sec_config_modes(id) ON DELETE CASCADE,

  CONSTRAINT fk_rule FOREIGN KEY (rule_id) REFERENCES sec_firewall_rules(id) ON DELETE CASCADE,

  INDEX idx_mode_sort (mode_id, sort_order) -- 复合索引，加速查询与排序

) COMMENT='配置与规则编排关联表';

***\*5. 脚本生成逻辑 (业务实现)\****

当需要为某个任务（例如 mode_id = 10）生成 iptables 脚本时，系统将执行以下逻辑：

### ***\*查询阶段：\****

通过 mode_id 关联查询，并严格按照 sort_order 排序。

SELECT r.* FROM sec_firewall_rules r

JOIN sec_mode_rule_relations rel ON r.id = rel.rule_id

WHERE rel.mode_id = 10 AND r.is_active = 1

ORDER BY rel.sort_order ASC; -- 关键：完全遵循用户的排序

### ***\*生成阶段：\****

后端程序遍历结果集，逐行映射为Shell命令。

l 第1行记录->生成脚本第1行（例如：优先封禁）。

l 第2行记录->生成脚本第2行（例如：业务放行）。

l ...

l 第N行记录->生成脚本第N行（例如：兜底拒绝）。

此设计确保了数据库结构不仅清晰，而且完美支持前端“拖拽排序”和后端“顺序执行”的业务闭环。

 